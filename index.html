<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.S. AEROSPACE | MISSION CONTROL</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050a0f;
            --panel-bg: rgba(10, 20, 30, 0.85);
            --neon-blue: #00f3ff;
            --neon-amber: #ffae00;
            --neon-green: #00ff41;
            --neon-red: #ff003c;
            --text-main: #e0e0e0;
            --grid-color: rgba(0, 243, 255, 0.05);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            background-image:
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- HEADER --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 40px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid var(--neon-blue);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
            position: relative;
            z-index: 10;
        }

        .header-title {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 2rem;
            margin: 0;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: #fff;
            text-shadow: 0 0 10px var(--neon-blue);
        }

        .mission-timer {
            text-align: right;
        }

        .mission-timer .label {
            font-size: 0.8rem;
            opacity: 0.7;
            letter-spacing: 2px;
        }

        .mission-timer .time {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            color: var(--neon-green);
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        /* --- DASHBOARD GRID --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 40px;
            max-width: 1600px;
            margin: 0 auto;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* --- PANELS --- */
        .panel {
            background: var(--panel-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 25px;
            position: relative;
            clip-path: polygon(0 0,
                    100% 0,
                    100% calc(100% - 20px),
                    calc(100% - 20px) 100%,
                    0 100%);
        }

        /* Decorative Corners */
        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100px;
            height: 2px;
            background: var(--neon-blue);
            box-shadow: 0 0 10px var(--neon-blue);
        }

        .panel.booster::before {
            background: var(--neon-amber);
            box-shadow: 0 0 10px var(--neon-amber);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: var(--neon-blue);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .panel.booster .panel-title {
            color: var(--neon-amber);
        }

        .status-badge {
            font-family: 'Orbitron', sans-serif;
            padding: 5px 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #fff;
            color: #fff;
            font-size: 0.9rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* --- METRICS --- */
        .metrics-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .metric-box {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
        }

        .metric-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
            display: block;
        }

        .metric-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: #fff;
        }

        .metric-unit {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.4);
            margin-left: 5px;
        }

        /* --- BARS --- */
        .bar-container {
            margin-top: 25px;
        }

        .bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .progress-track {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--neon-blue);
            width: 0%;
            transition: width 0.3s ease-out;
            box-shadow: 0 0 10px var(--neon-blue);
            position: relative;
        }

        .panel.booster .progress-fill {
            background: var(--neon-amber);
            box-shadow: 0 0 10px var(--neon-amber);
        }

        /* Striped bar effect */
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: linear-gradient(45deg, rgba(0, 0, 0, 0.2) 25%, transparent 25%,
                    transparent 50%, rgba(0, 0, 0, 0.2) 50%,
                    rgba(0, 0, 0, 0.2) 75%, transparent 75%, transparent);
            background-size: 20px 20px;
        }

        /* --- ENGINE CLUSTER --- */
        .engine-display {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            width: 200px;
            height: 200px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            border: 1px dashed rgba(255, 255, 255, 0.2);
        }

        .engine-node {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #333;
            background: #111;
            box-shadow: inset 0 0 5px #000;
            transition: all 0.3s;
        }

        .engine-node.active {
            background: #fff;
            border-color: #fff;
            box-shadow: 0 0 15px currentColor;
        }

        .panel.ship .engine-node.active {
            color: var(--neon-blue);
        }

        .panel.booster .engine-node.active {
            color: var(--neon-amber);
        }

        /* --- FOOTER --- */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px 40px;
            font-family: monospace;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            z-index: 100;
        }

        .blink {
            animation: blinker 1.5s linear infinite;
        }

        @keyframes blinker {
            50% {
                opacity: 0;
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="header-container">
            <div class="header-title">J.S. AEROSPACE</div>
        </div>
        <div class="mission-timer">
            <div class="label">MISSION ELAPSED TIME</div>
            <div class="time" id="met-display">T+ 00:00:00</div>
        </div>
    </header>

    <div class="dashboard-grid">

        <!-- === BOOSTER PANEL (IZQUIERDA) === -->
        <div class="panel booster">
            <div class="panel-header">
                <div class="panel-title">BOOSTER / S1</div>
                <div class="status-badge" id="booster-status">STANDBY</div>
            </div>

            <div class="metrics-container">
                <div class="metric-box">
                    <span class="metric-label">Altitud</span>
                    <span class="metric-value" id="booster-alt">0</span>
                    <span class="metric-unit">m</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">Velocidad</span>
                    <span class="metric-value" id="booster-vel">0</span>
                    <span class="metric-unit">m/s</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">V. Vertical</span>
                    <span class="metric-value" id="booster-vs">0.0</span>
                    <span class="metric-unit">m/s</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">Dist. Aterrizaje</span>
                    <span class="metric-value" id="booster-dist">0</span>
                    <span class="metric-unit">m</span>
                </div>
            </div>

            <div class="bar-container">
                <div class="bar-label">
                    <span>METHANE / LOX (BOOSTER)</span>
                    <span id="booster-fuel-pct">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="booster-fuel-bar"></div>
                </div>
            </div>

            <div class="bar-container">
                <div class="bar-label">
                    <span>Potencia Motor (Throttle)</span>
                    <span id="booster-thr-pct">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="booster-thr-bar" style="width: 0%"></div>
                </div>
            </div>

            <div class="engine-display" id="booster-engines" data-type="booster">
                <!-- Engines JS generated -->
            </div>
        </div>

        <!-- === SHIP PANEL (DERECHA) === -->
        <div class="panel ship">
            <div class="panel-header">
                <div class="panel-title">ORBITER / S2</div>
                <div class="status-badge" id="ship-status">STANDBY</div>
            </div>

            <div class="metrics-container">
                <div class="metric-box">
                    <span class="metric-label">Apoapsis</span>
                    <span class="metric-value" id="ship-apo">0.0</span>
                    <span class="metric-unit">km</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">Periapsis</span>
                    <span class="metric-value" id="ship-per">0.0</span>
                    <span class="metric-unit">km</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">Delta-V</span>
                    <span class="metric-value" id="ship-dv">0</span>
                    <span class="metric-unit">m/s</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">Velocidad Orbital</span>
                    <span class="metric-value" id="ship-vel">0</span>
                    <span class="metric-unit">m/s</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">Altitud</span>
                    <span class="metric-value" id="ship-alt">0</span>
                    <span class="metric-unit">m</span>
                </div>
                <div class="metric-box">
                    <span class="metric-label">Inclincación</span>
                    <span class="metric-value" id="ship-inc">0.0</span>
                    <span class="metric-unit">°</span>
                </div>
            </div>

            <div class="bar-container">
                <div class="bar-label">
                    <span>METHALOX (VACUUM)</span>
                    <span id="ship-fuel-pct">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="ship-fuel-bar"></div>
                </div>
            </div>

            <div class="bar-container">
                <div class="bar-label">
                    <span>Potencia Motor</span>
                    <span id="ship-thr-pct">0%</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="ship-thr-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Single Engine for S2 -->
            <div class="engine-display" id="ship-engines" data-type="ship" style="width: 120px; height: 120px;">
                <div id="s2-engine-main" class="engine-node"
                    style="width: 60px; height: 60px; top: 30px; left: 30px; border-width: 4px;"></div>
            </div>
        </div>

    </div>

    <div class="status-bar">
        <span>CONEXIÓN: <span id="conn-status" style="color:red">OFFLINE</span></span>
        <span>ID DE DATOS: <span id="data-id" style="color:#aaa">-</span></span>
        <span>SISTEMA VISUAL: v2.0 READY</span>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCiZs5Edhj2M0GIroo7thpD-fz6UOWpoZQ",
            authDomain: "control-de-mision-js.firebaseapp.com",
            projectId: "control-de-mision-js",
            storageBucket: "control-de-mision-js.firebasestorage.app",
            messagingSenderId: "771859762827",
            appId: "1:771859762827:web:00caa47bca9e3aad5b4e8e",
            measurementId: "G-WY3SGSG5YM",
            databaseURL: "https://control-de-mision-js-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- FUNCIONES UTILITARIAS ---
        const fmtNum = (n) => Math.round(n).toLocaleString();
        const fmtDec = (n, d = 1) => (n || 0).toFixed(d);

        // --- PARSEADOR ROBUSTO DE LEXICONS KOS ---
        function parseKosJson(data) {
            // Caso base: si es null o no es objeto, devolver tal cual
            if (!data || typeof data !== 'object') return data;

            // Caso 1: Estructura { entries: [...], $type: "Lexicon" }
            if (data.entries && Array.isArray(data.entries)) {
                const result = {};
                const ent = data.entries;

                if (ent.length === 0) return result;

                // DETECCIÓN DE FORMATO: kOS a veces exporta pares {key, value} y otras veces lista plana alterna
                // telemetry_stage2.json confirma formato PLANO: [Key, Value, Key, Value...]
                const first = ent[0];
                const isTypeA = (first && typeof first === 'object' && first.key !== undefined);

                if (isTypeA) {
                    // Estrategia A: Lista de Pares [{key:..., value:...}]
                    for (let entry of ent) {
                        try {
                            let k = (entry.key && entry.key.value !== undefined) ? entry.key.value : entry.key;
                            let v = (entry.value && entry.value.value !== undefined) ? entry.value.value : entry.value;
                            if (v && typeof v === 'object') v = parseKosJson(v);
                            if (k !== null && k !== undefined) result[String(k)] = v;
                        } catch (e) { }
                    }
                } else {
                    // Estrategia B: Lista Plana [KeyObj, ValueObj, KeyObj, ValueObj]
                    // Usada actualmente por tus scripts kOS
                    for (let i = 0; i < ent.length - 1; i += 2) {
                        try {
                            let kObj = ent[i];
                            let vObj = ent[i + 1];
                            let k = (kObj.value !== undefined) ? kObj.value : kObj;
                            let v = (vObj.value !== undefined) ? vObj.value : vObj;

                            if (v && typeof v === 'object') v = parseKosJson(v);
                            if (k !== null && k !== undefined) result[String(k)] = v;
                        } catch (e) { }
                    }
                }
                return result;
            }

            // Caso 2: Estructura { values: [...], $type: "List" }
            if (data.values && Array.isArray(data.values)) {
                return data.values.map(item => {
                    let v = (item.value !== undefined) ? item.value : item;
                    return parseKosJson(v);
                });
            }

            // Caso 3: Objeto estándar, recursión en sus propieades
            // (Para cuando ya tenemos un dict limpio o una estructura mixta)
            const processed = {};
            let hasProps = false;
            for (let k in data) {
                if (k === '$type') continue; // Ignorar metadatos de tipo kOS
                processed[k] = parseKosJson(data[k]);
                hasProps = true;
            }
            // Si tenía propiedades, devolvemos el objeto procesado. Si no, devolvemos data tal cual (ej. "R1")
            return hasProps ? processed : data;
        }

        // --- GENERADOR DE MOTORES ---
        // --- GENERADOR DE MOTORES CONFIGURACION 11 (Booster) y 1 (Ship) ---
        function initBoosterEngines() {
            const container = document.getElementById('booster-engines');
            container.innerHTML = '';
            const cx = 100, cy = 100; // Center of 200x200

            // 1. Center Cluster (3 engines - C1, C2, C3)
            for (let i = 0; i < 3; i++) {
                const angle = (i * 120 - 90) * (Math.PI / 180);
                const r = 30; // 30px radius
                const x = cx + r * Math.cos(angle);
                const y = cy + r * Math.sin(angle);
                createNode(container, `C${i + 1}`, x, y, 32);
            }

            // 2. Ring (8 engines - R1..R8)
            for (let i = 0; i < 8; i++) {
                const angle = (i * 45 - 90) * (Math.PI / 180);
                const r = 80; // 80px radius
                const x = cx + r * Math.cos(angle);
                const y = cy + r * Math.sin(angle);
                createNode(container, `R${i + 1}`, x, y, 24);
            }
        }

        function initShipEngines() {
            const container = document.getElementById('ship-engines');
            container.innerHTML = '';
            const cx = 60, cy = 60; // Center of 120x120

            // Single Engine S1
            createNode(container, 'S1', cx, cy, 60);
        }

        function createNode(parent, tag, x, y, size) {
            const div = document.createElement('div');
            div.className = 'engine-node';
            div.dataset.tag = tag;
            div.innerText = tag;
            div.style.width = size + 'px';
            div.style.height = size + 'px';
            div.style.left = (x - size / 2) + 'px';
            div.style.top = (y - size / 2) + 'px';
            div.style.fontSize = Math.max(8, size / 3) + 'px';
            div.style.display = 'flex';
            div.style.alignItems = 'center';
            div.style.justifyContent = 'center';
            div.style.color = '#000';
            div.style.fontWeight = 'bold';
            parent.appendChild(div);
        }

        initBoosterEngines();
        initShipEngines();

        // --- CORE UPDATE LOOP ---
        const telemetryRef = ref(db, '/');
        onValue(telemetryRef, (snapshot) => {
            const raw = snapshot.val();
            if (!raw) return;

            // Update Connection Status
            document.getElementById('conn-status').innerText = "ONLINE (LIVE)";
            document.getElementById('conn-status').style.color = "#00ff41";
            document.getElementById('conn-status').classList.add('blink');

            const S2 = parseKosJson(raw.ship || raw.SHIP);
            const B1 = parseKosJson(raw.booster || raw.BOOSTER);

            // ACTUALIZAR BOOSTER
            // ACTUALIZAR BOOSTER
            if (B1) {
                document.getElementById('booster-status').innerText = B1.status || B1.STATUS || "UNDEFINED";
                document.getElementById('booster-status').style.borderColor = "#ffae00";

                document.getElementById('booster-alt').innerText = fmtNum(B1.alt || B1.ALT);
                document.getElementById('booster-vel').innerText = fmtNum(B1.vel || B1.VEL);
                document.getElementById('booster-vs').innerText = fmtDec(B1.vs || B1.VS, 1);
                document.getElementById('booster-hdist').innerText = fmtNum(B1.hdist || B1.HDIST || B1.dist || B1.DIST); // Multiple fallbacks

                // Fuel & Throttle
                const fPct = B1.fuelPct || B1.FUELPCT || 0;
                document.getElementById('booster-fuel-bar').style.width = fPct + "%";
                document.getElementById('booster-fuel-pct').innerText = Math.round(fPct) + "%";

                const thr = B1.thr || B1.THR || 0;
                document.getElementById('booster-thr-bar').style.width = thr + "%";
                document.getElementById('booster-thr-pct').innerText = Math.round(thr) + "%";

                // Engines
                const engs = B1.engStates || B1.ENGSTATES;
                if (engs) {
                    for (let tag in engs) {
                        const state = engs[tag];
                        const el = document.querySelector(`#booster-engines [data-tag="${tag}"]`);
                        if (el) {
                            if (state === 1) el.classList.add('active');
                            else el.classList.remove('active');
                        }
                    }
                }
            }

            // ACTUALIZAR SHIP
            if (S2) {
                document.getElementById('ship-status').innerText = S2.status || S2.STATUS || "UNDEFINED";
                document.getElementById('ship-status').style.borderColor = "#00f3ff";

                document.getElementById('ship-alt').innerText = fmtNum(S2.alt || S2.ALT);
                document.getElementById('ship-vel').innerText = fmtNum(S2.vel || S2.VEL);
                document.getElementById('ship-apo').innerText = fmtDec((S2.apo || S2.APO || 0) / 1000, 1);
                document.getElementById('ship-per').innerText = fmtDec((S2.per || S2.PER || 0) / 1000, 1);
                document.getElementById('ship-dv').innerText = fmtNum(S2.dv || S2.DV);

                // Fuel & Throttle
                const fPct = S2.fuelPct || S2.FUELPCT || 0;
                document.getElementById('ship-fuel-bar').style.width = fPct + "%";
                document.getElementById('ship-fuel-pct').innerText = Math.round(fPct) + "%";

                const thr = S2.thr || S2.THR || 0;
                document.getElementById('ship-thr-bar').style.width = thr + "%";
                document.getElementById('ship-thr-pct').innerText = Math.round(thr) + "%";

                // Ship Engines (Cluster de 6)
                const engs = S2.engStates || S2.ENGSTATES;
                if (engs) {
                    for (let tag in engs) {
                        const state = S2.engStates[tag];
                        const el = document.querySelector(`#ship-engines [data-tag="${tag}"]`);
                        if (el) {
                            if (state === 1) el.classList.add('active');
                            else el.classList.remove('active');
                        }
                    }
                } else {
                    // Fallback visual si no hay data individual: encender todos si throttle > 0
                    const allShipEngs = document.querySelectorAll('#ship-engines .engine-node');
                    allShipEngs.forEach(el => {
                        if (thr > 1) el.classList.add('active');
                        else el.classList.remove('active');
                    });
                }
            }

            // MISSION TIME (Simulado o real si viene en raw)
            // Si no viene MET real, podemos hacer un contador fake o usar time del servidor
            // Asumimos que viene un METString o lo calculamos
            // Por simplicidad, ponemos ONLINE
            document.getElementById('met-display').innerText = "T+ LIVE";

            // --- DEBUG OVERLAY (AUTO-INJECT) ---
            if (Object.keys(B1 || {}).length > 0 || Object.keys(S2 || {}).length > 0) {
                const bKeys = Object.keys(B1 || {}).sort().join(", ");
                const sKeys = Object.keys(S2 || {}).sort().join(", ");

                const debugInfo = [
                    "--- DEBUG DASHBOARD v2.1 ---",
                    "BOOSTER (B1) KEYS FOUND: " + bKeys,
                    "",
                    "B1.fuelPct: " + JSON.stringify(B1.fuelPct),
                    "B1.FUELPCT: " + JSON.stringify(B1.FUELPCT),
                    "B1.thr: " + JSON.stringify(B1.thr),
                    "B1.THR: " + JSON.stringify(B1.THR),
                    "B1.engStates: " + (B1.engStates ? JSON.stringify(B1.engStates).substring(0, 50) + "..." : "UNDEFINED"),
                    "",
                    "TIMESTAMP: " + new Date().toISOString()
                ].join("\n");

                let dbg = document.getElementById('debug-overlay');
                if (!dbg) {
                    dbg = document.createElement('div');
                    dbg.id = 'debug-overlay';
                    dbg.style.position = 'fixed';
                    dbg.style.bottom = '10px';
                    dbg.style.left = '10px';
                    dbg.style.background = 'rgba(0,0,0,0.85)';
                    dbg.style.color = '#0f0';
                    dbg.style.fontFamily = 'monospace';
                    dbg.style.fontSize = '12px';
                    dbg.style.padding = '15px';
                    dbg.style.border = '1px solid #0f0';
                    dbg.style.zIndex = '9999';
                    dbg.style.whiteSpace = 'pre-wrap';
                    dbg.style.maxWidth = '600px';
                    document.body.appendChild(dbg);
                }
                dbg.innerText = debugInfo;
            }
        });

    </script>
</body>

</html>